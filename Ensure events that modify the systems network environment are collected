---
- name: Ensure events modifying the system's network environment are collected on Debian 12
  hosts: all
  become: yes

  tasks:
    - name: Install auditd package
      apt:
        name: auditd
        state: present

    - name: Ensure audit rules for network environment modifications
      copy:
        content: |
          -a always,exit -F arch=b64 -S sethostname -k network_modifications
          -a always,exit -F arch=b32 -S sethostname -k network_modifications
          -a always,exit -F arch=b64 -S setdomainname -k network_modifications
          -a always,exit -F arch=b32 -S setdomainname -k network_modifications
          -a always,exit -F arch=b64 -S setsockopt -k network_modifications
          -a always,exit -F arch=b32 -S setsockopt -k network_modifications
          -a always,exit -F arch=b64 -S bind -k network_modifications
          -a always,exit -F arch=b32 -S bind -k network_modifications
          -a always,exit -F arch=b64 -S listen -k network_modifications
          -a always,exit -F arch=b32 -S listen -k network_modifications
          -a always,exit -F arch=b64 -S socket -k network_modifications
          -a always,exit -F arch=b32 -S socket -k network_modifications
          -a always,exit -F arch=b64 -S connect -k network_modifications
          -a always,exit -F arch=b32 -S connect -k network_modifications
        dest: /etc/audit/rules.d/network_modifications.rules

    - name: Reload auditd rules
      command: auditctl -R /etc/audit/rules.d/network_modifications.rules

    - name: Restart auditd service
      service:
        name: auditd
        state: restarted
