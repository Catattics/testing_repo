---
- name: Install Splunk Universal Forwarder on Debian 12
  hosts: all
  become: yes  # Run tasks with elevated privileges

  vars:
    splunk_version: "9.1.2"  # Replace with the desired Splunk version
    splunk_build: "b6b9c8185839"  # Replace with the desired Splunk build
    splunk_home: "/opt/splunkforwarder"
    splunk_user: "splunk"

  tasks:
    - name: Download Splunk Universal Forwarder
      ansible.builtin.get_url:
        url: "https://www.splunk.com/bin/splunk/DownloadActivityServlet?architecture=x86_64&platform=linux&version={{ splunk_version }}&product=universalforwarder&filename=splunkforwarder-{{ splunk_version }}-{{ splunk_build }}-Linux-x86_64.tgz"
        dest: "/tmp/splunkforwarder.tgz"
    
    - name: Extract Splunk Universal Forwarder
      ansible.builtin.unarchive:
        src: "/tmp/splunkforwarder.tgz"
        dest: "{{ splunk_home }}"
        remote_src: yes  # Extract on the remote machine

    - name: Create Splunk user
      ansible.builtin.user:
        name: "{{ splunk_user }}"
        system: yes

    - name: Set ownership of Splunk directory
      ansible.builtin.file:
        path: "{{ splunk_home }}"
        owner: "{{ splunk_user }}"
        group: "{{ splunk_user }}"
        recurse: yes

    - name: Start Splunk Universal Forwarder
      ansible.builtin.command:
        cmd: "{{ splunk_home }}/bin/splunk start --accept-license --answer-yes --auto-ports"
      become_user: "{{ splunk_user }}"

    - name: Enable Splunk Universal Forwarder at boot
      ansible.builtin.command:
        cmd: "{{ splunk_home }}/bin/splunk enable boot-start"
      become_user: "{{ splunk_user }}"
