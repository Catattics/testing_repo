---
- name: Install Splunk Universal Forwarder on Debian 12
  hosts: all
  become: yes  # Run tasks with elevated privileges

  vars:
    splunk_home: "/opt/splunkforwarder"
    splunk_user: "ansible_user"
    splunk_download_url: "https://download.splunk.com/products/universalforwarder/releases/9.1.2/linux/splunkforwarder-9.1.2-b6b9c8185839-Linux-x86_64.tgz"

  tasks:
    - name: Create Splunk Universal Forwarder directory
      ansible.builtin.file:
        path: "{{ splunk_home }}"
        state: directory
        owner: "{{ splunk_user }}"
        group: "{{ splunk_user }}"

    - name: Download Splunk Universal Forwarder
      ansible.builtin.get_url:
        url: "{{ splunk_download_url }}"
        dest: "/tmp/splunkforwarder.tgz"
    
    - name: Extract Splunk Universal Forwarder
      ansible.builtin.unarchive:
        src: "/tmp/splunkforwarder.tgz"
        dest: "{{ splunk_home }}"
        remote_src: yes  # Extract on the remote machine

    - name: Create Splunk user
      ansible.builtin.user:
        name: "{{ splunk_user }}"
        system: yes

    - name: Set ownership of Splunk directory
      ansible.builtin.file:
        path: "{{ splunk_home }}"
        owner: "{{ splunk_user }}"
        group: "{{ splunk_user }}"
        recurse: yes

    - name: Start Splunk Universal Forwarder
      ansible.builtin.command:
        cmd: "{{ splunk_home }}/bin/splunk start --accept-license --answer-yes --auto-ports"
      become_user: "{{ splunk_user }}"

    - name: Enable Splunk Universal Forwarder at boot
      ansible.builtin.command:
        cmd: "{{ splunk_home }}/bin/splunk enable boot-start"
      become_user: "{{ splunk_user }}"

    - name: Download inputs.conf template
      get_url:
        url: "https://raw.githubusercontent.com/Catattics/testing_repo/main/inputs.conf"
        dest: /opt/splunkforwarder/etc/system/local/

    - name: Configure Splunk Universal Forwarder
      ansible.builtin.copy:
        src: "inputs.conf"
        dest: "/opt/splunkforwarder/etc/system/local/"
        mode: "0644"
      notify:
        - Restart Splunk Forwarder
